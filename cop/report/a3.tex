\documentclass{article}

\usepackage{fullpage}
\usepackage[latin1]{inputenc}
\usepackage[danish]{babel}
\usepackage{listings}
\usepackage{caption}
\usepackage[table]{xcolor}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{parskip}
\usepackage{abstract}
\usepackage{url}
\usepackage{float}
\usepackage{enumitem}
\usepackage[all]{xy}
\usepackage{amstext}
\usepackage{fancybox}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage[bottom]{footmisc}
\usepackage{hyperref}
\usepackage{tikz}
\usepackage{makecell}

% bootstrap label style highlighting
\newcommand\hw[2][]{\tikz[overlay]\node[fill=blue!20,inner sep=1pt, anchor=text, rectangle, rounded corners=0.1mm,#1] {#2};\phantom{#2}}

% styling
\newcommand{\code}[1]{\texttt{#1}}

% diagrams
\newcommand{\switch}[1]%
  {\ovalbox{\text{\begin{minipage}{1.2in}\centering #1\end{minipage}}}}
\newcommand{\minibox}[1]%
  {\ovalbox{\text{\begin{minipage}{0.85in}\centering #1\end{minipage}}}}

\pagestyle{fancy}
\fancyhf{}
\setlength{\parindent}{0pt}
\setlength{\headheight}{15pt}
\setlength{\headsep}{25pt}
\lfoot{Side \thepage{} af \pageref{LastPage}}
\rfoot{09/12-2013}
\lhead{Embedded Systems}
\chead{Assignment 3}
\rhead{}

\title{Assignment 3}
\date{09.12.2013}
\author{
  Simon Altschuler\\
  \code{s123563}
  \and
  Markus Færevaag\\
  \code{s123692}
}

\begin{document}
\maketitle
\centerline{Gruppens arbejde har været fordelt lige i forbindelse med udarbejdelse
af opgaven og rapporten.}
\clearpage

\tableofcontents
\clearpage

\section{Introduktion} % Norsk
Vi har i denne oppgave re-implementeret vores MWI filter fra A2 i form
af en co-processor, som styres af processoren i vores tidligere
system. De kommunikerer over bussen og er ikke direkte forbundet.

Dette gjoer at vi kan oppnaa en helt annen ydelse naar det gjelder
analysen av dataen, resulterende en endnu mer realistisk loesning av et
komplett inlejret system.

\section{Problemstilling}
\subsection{Fokus}
Det er nødvendigt at vælge hvilke aspekter af ydeevne man vil
fokuserer på når man skal designe en processor, eller i dette tilfælde
en co-processor. I nogle tilfælde, f.eks. GPU'er, er det altafgørende
hvor hurtigt enheden kan behandle tal. Hvis denne GPU skulle bruges i
en mobil enhed, ville det være at samme kritiske karakter at den ikke
bruger for meget strøm og at den er lille nok til at en moderne
telefon har plads til den.

I vores tilfælde er strømforbrug ikke en særlig vigtig egenskab. Det
er naturligvis hensigsmæssigt at systemet som helhed bruger så lidt
strøm som muligt, men da der er mange andre komponenter indblandet
(såsom skærm, sensore og højtalere) vil vores co-processor aldrig
blive den afgørende faktor for det samlede strømforbrug.

Pladsforbrug er ej heller af høj betydning. Vi ved at størrelsen på
co-processoren realistisk set ville være utroligt lille, så om den
fylder $0.5mm^2$ eller $5mm^2$ er ikke noget, der vil afgøre én
implementationsmetode over en anden.

Vi vælger til slut at fokusere hovedsageligt på hastighedsmæssig
ydeevne. Medicinalt udstyr bør frem for alt være pålideligt og
præcist, og det er derfor afgørende at hardwaren aldrig bliver en
flaskehals for dataanalysen. Vi vil hellere have et system som bruger
lidt mere strøm, og altid er pålideligt. 

Som anden prioritet vil vi optimere for strømforbrug. Vi vil finde
passende algoritmer der opfylder vores hastighedsmæssige krav og
forsøge at optimere disse til et minimalt strømforbrug.

\subsection{Algoritmer}
Ud fra vores fokus på hastighed skal vi finde nogle algoritmer som
opfylder vores krav til systemet. Disse krav inkluderer bl.a.~at
co-processoren skal kunne udregne en nyt MWI værdi på én cycle. På den
måde slipper vi for at systemet venter på udregningen og kan gå i
hvile eller udføre andre opgaver inden det næste data sample bliver
sent til main processoren.

Vores krav til energiforbruget er som udgangspunkt mere vage da vi ved
at det vil afhænge af hvilket design vi finder passende
mht.~hastighed. Vi stiller dermed det krav at energiforbruget ikke må
overstige, og helst være under, det i A2 funde forbrug.

Hvis vi ikke havde valgt at fokusere på hastighed, og i stedet
optimeret for eksempelvis pladsforbrug, ville vi have undersøgt
hvordan vi kunne bruge færrest mulige registre og andre komponenter i
implementationen.

\section{Design}
\subsection{Fokus}
Vi vælger at fokuserer på hastighed, størrelse er
irrelevant. Energiforbrug er af mindre betydning, men er stadig værd
at overveje. En skærm vil alligevel være den klart mest energimæssigt
krævende enhed.

At bruge 30 registre vs at bruge 4 og loade tilbage. Vi bruger 30+lidt
for at undgå ekstra load.


\section{Implementation}
\subsection{Overordnet}
\begin{figure}[H]
\includegraphics[width=18cm]{diagrams/copro.pdf}
\label{fig:schematic}
\caption{Skema over MWI co-processor implementationen}
\end{figure}

Bruger positive værdier da vi ved det er fucking fedt. Le fak?

\subsection{Register komponent}
Bruger 30 registre
Beskriv ``pointer'' metoden
Behøver ikke at tjekke hvor mange samples der er observeret fordi registre som standard = 0

\subsection{MWI udregning}
Bruger akkumulator, hardcoded division

\section{Profilering}
\subsection{Strømforbrug}
Vi måler strømforbruget nøjagtig som vi gjorde det i A2, blot med
nyligt målte antal toggle. Først finder vi en realistisk clock
frekvens til CPU'en. Vi ved fra forrige opgave at samples bliver målt
$250/s$, og vi bruger $31$ cycles på at udregne en MWI værdi. Vi har
altså at

\[  \frac{1\ s}{250 * 31\ cycles} = 129\frac{\mu s}{cycle}  \]

Fra dette kan vi finde det ønskede antal cycles per sekund (clock frekvensen):

\[  \frac{1s}{129\frac{\mu s}{cycle}} = 7752\ cycles \]

Vi vil altså gerne udføre $7752$ cycles i sekundet, og dermed en have
clock frekvens på $7752\ Hz$. Vi runder op til $8\ kHz$ da vi vil undgå
en clock speed, der er for langsom til at følge med sample raten.

Nu ser vi på hvor mange toggles der bliver udført per sekund, se
tabel~\ref{table:toggles}. Vi målte $3545$ toggles for én MWI
udregning, og vi fandt $31$ cycles per MWI. Dette giver os
$\frac{3545}{31} \approx 115\ toggles/mwi $. Vi ved at vi skal lave
omkring $250$ MWI udregninger per sekund, hvorfor vi ganger med dette:
$115 \cdot 250 = 28750$

Vi finder nu strømforbruget af CPU vha.~af følgende formel:
\[  \alpha \cdot C \cdot V_{dd}^2 \cdot f \]

Hvor $\alpha$ er aktivitet, $C$ er kapacitans, $V_{dd}$ er spænding og
$f$ er clock frekvens. Vi bruger de udleverede værdier, nemlig $V_{dd}
= 1.2\ V$ og $C = 1.8 \cdot 10^{-16}\ F$ og får følgende:

\[28750 \cdot 1.8 \cdot 10^{-16}\ F \cdot {(1.2\ V)}^2 \cdot 8\ kHz = 0.05962\ microwatts \]

\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|c|c|}
    \hline \rowcolor{blue!25}
    Operation  & Slut MWI & Start MWI & Forskel \\ \hline
    dpoutput   & 190083   & 189329    & 754     \\ \hline
    reg        & 90510    & 90147     & 363     \\ \hline
    sig        & 116382   & 115913    & 469     \\ \hline
    assign\_op & 257210   & 256181    & 1029    \\ \hline
    ior\_op    & 13492    & 13436     & 56      \\ \hline
    and\_op    & 12579    & 12526     & 53      \\ \hline
    shl\_op    & 493      & 493       & 0       \\ \hline
    add\_op    & 19187    & 19109     & 78      \\ \hline
    sub\_op    & 995      & 992       & 3       \\ \hline
    concat\_op & 4441     & 4424      & 17      \\ \hline
    mul\_op    & 3024     & 3010      & 14      \\ \hline
    cast\_op   & 7060     & 7032      & 28      \\ \hline
    not\_op    & 1452     & 1446      & 6       \\ \hline
    sel\_op    & 119182   & 118726    & 456     \\ \hline
    eq\_op     & 40642    & 40471     & 171     \\ \hline
    ne\_op     & 2990     & 2976      & 14      \\ \hline
    smt\_op    & 0        & 0         & 0       \\ \hline
    grt\_op    & 28       & 28        & 0       \\ \hline
    ipoutput   & 9159     & 9125      & 34      \\ \Xhline{2\arrayrulewidth}

    total      & 888909   & 885364    & \cellcolor{blue!10} 3545    \\ \hline
    cycle      & 7471     & 7440      & \cellcolor{blue!10} 31      \\ \hline
  \end{tabular}
  \caption{Toggle data fra Gezel}
  \label{table:toggles}
\end{table}

\section{Test}
Vi har testet de tre komponenter hver især i separate filer (med
{\_test.fdl} endelse). Da man ikke kan lave deciderede unit tests i
Gezel har vi i stedet brugt \code{\$display} til at undersøge om
outputtet af et komponent stemte overens med vores forventninger. Det
er ikke særlig holdbart og kan være kilde til fejlagtig acceptering,
men i dette størrelsesforhold har det været tilstrækkeligt.

Vi har brugt en \code{sequencer} state machine i hver test til at
gennenløbe forskellige \code{sfg}er i rækkefølge, da vi på den måde
nemt har kunnet simulere en strøm af data. Eksempelvis er der i
\code{mwi\_test.fdl} 7 forskellige states, som hver udfører en enkelt
operation og vi kan i outputtet følge med i, om det korrekte
output vises.

Det er svært at teste integrationen af co-processoren i bussen på
denne måde, dels grundet bussens kompleksitet og dels fordi det er
svært at skrive en \code{fsm} til at holde styr på state og memory. Vi
har derfor ingen automatisk test til dette, men har blot tjekket
output manuelt mens vi har kørt simuleringen.

\section{Resultater}
Vi opdagede under udarbejdelsen af denne rapport at vi har lavet en
fejl i vores måling af energiforbrug i A2. Vi havde udregnet den
forkerte aktivitet. Den skulle have været $42000$, da vi havde glemt
at gange toggles/MWI med $250$. Dette giver os et energiforbrug i A2
på $0.1089\ \mu w$\footnote{Udregningen er $42000 \cdot 1.8 \cdot
  10^{-16}\ F \cdot {(1.2\ V)}^2 \cdot 10\ kHz = 0.1089\ \mu$}.

Tabel~\ref{table:comparison} giver et overblik over de f

\begin{table}[H]
  \centering
  \begin{tabular}{|c|c|c|c|}
    \hline \rowcolor{blue!25} \cellcolor{blue!25}
        & Med              & Uden            & Forhold \\ \hline \cellcolor{blue!25}
Toggles & $3545$           & $6548$          & $0.54$ \\ \hline \cellcolor{blue!25}
Cycles  & $7471$           & $9414$          & $0.79$ \\ \hline \cellcolor{blue!25}
Energi  & $0.05962\ \mu w$ & $0.1089\ \mu w$ & $0.55$ \\ \hline
  \end{tabular}
  \caption{Sammenligning af implementation med og uden co-processor}
  \label{table:comparison}
\end{table}

Vi ser at der på alle områder er en sket en markant forbedring. Det
hænger til dels sammen, da mindre cycles generelt betyder lavere
energiforbrug og færre toggles. Det er interessant at det gør en så
stor forskel på en forholdsvis simpel opgave.

\section{Konlusion}

\section{Kørsel}

\end{document}
